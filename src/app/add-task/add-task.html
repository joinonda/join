<section
  class="addtask-section"
  role="form"
  aria-labelledby="addtask-heading"
  aria-describedby="required-info"
>
  <div class="addtask-header">
    <h2 id="addtask-heading">Add Task</h2>
  </div>

  <div class="addtask-content">
    <div class="form-left-and-form-right">
      <div class="form-left" [formGroup]="form">
        <div class="title-form form-field">
          <div class="title-and-validation">
            <label for="title">Title<span class="required">*</span></label>
            @if (title?.touched && title?.invalid) {
            <p class="error-text" id="title-error" role="alert" aria-live="polite">
              @if (title?.hasError('required')) { Title is required. } @else if
              (title?.hasError('minlength')) { Use at least 3 characters. }
            </p>
            }
          </div>

          <input
            id="title"
            type="text"
            placeholder="Enter a title"
            formControlName="title"
            [attr.aria-invalid]="title?.touched && title?.invalid"
            aria-describedby="title-error"
            aria-required="true"
          />
        </div>

        <div class="description-form form-field">
          <label for="description">Description</label>
          <textarea
            id="description"
            placeholder="Enter a description"
            formControlName="description"
          ></textarea>
        </div>

        <div class="due-date-form form-field">
          <div class="title-and-validation">
            <label for="dueDate">Due date<span class="required">*</span></label
            >@if (dueDate?.touched && dueDate?.invalid) {
            <p class="error-text" id="dueDate-error" role="alert" aria-live="polite">
              @if (dueDate?.hasError('required')) { Due date is required. } @else if
              (dueDate?.hasError('pastDate')) { Choose a future date. }
            </p>
            }
          </div>

          <input
            id="dueDate"
            type="date"
            class="date-input"
            formControlName="dueDate"
            [attr.min]="todayStr"
            [attr.aria-invalid]="dueDate?.touched && dueDate?.invalid"
            aria-describedby="dueDate-error"
            aria-required="true"
          />
        </div>
      </div>
      <div class="divider">
        <div class="divider-line"></div>
      </div>

      <div class="form-right" [formGroup]="form">
        <div class="priority-form form-field">
          <label id="priority-label">Priority</label>
          <div class="priority-buttons" role="radiogroup" [attr.aria-labelledby]="'priority-label'">
            <button
              type="button"
              class="priority-button urgent"
              role="radio"
              [attr.aria-checked]="form.value.priority === 'urgent'"
              (click)="prioritySelect('urgent')"
            >
              Urgent
              <img src="imgs/addtask/urgent-normal.png" alt="" class="priority-icon-normal" />
              <img src="imgs/addtask/urgent-hover.png" alt="" class="priority-icon-hover" />
            </button>
            <button
              type="button"
              class="priority-button medium"
              role="radio"
              [attr.aria-checked]="form.value.priority === 'medium'"
              (click)="prioritySelect('medium')"
            >
              Medium
              <img src="imgs/addtask/medium-normal.png" alt="" class="priority-icon-normal" />
              <img src="imgs/addtask/medium-hover.png" alt="" class="priority-icon-hover" />
            </button>
            <button
              type="button"
              class="priority-button low"
              role="radio"
              [attr.aria-checked]="form.value.priority === 'low'"
              (click)="prioritySelect('low')"
            >
              Low
              <img src="imgs/addtask/low-normal.png" alt="" class="priority-icon-normal" />
              <img src="imgs/addtask/low-hover.png" alt="" class="priority-icon-hover" />
            </button>
          </div>
        </div>

        <div class="assigned-to-form form-field">
          <label for="assignedTo">Assigned to</label>
          <div class="dropdown-container">
            <div
              class="dropdown-input"
              (click)="toggleDropdown()"
              [attr.data-open]="isDropdownOpen()"
            >
              <input
                id="assignedTo"
                type="text"
                placeholder="Select contacts to assign"
                [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event)"
                [ngModelOptions]="{ standalone: true }"
                (click)="$event.stopPropagation()"
                (focus)="isDropdownOpen.set(true)"
                class="dropdown-search"
                role="combobox"
                aria-autocomplete="list"
                aria-haspopup="listbox"
                [attr.aria-expanded]="isDropdownOpen()"
                aria-controls="assignedTo-list"
              />
              <span class="dropdown-arrow" aria-hidden="true"></span>
            </div>
            @if (isDropdownOpen()) {
            <div class="dropdown-list" id="assignedTo-list" role="listbox">
              @for (contact of filteredContacts(); track contact.id) {
              <div
                class="dropdown-item"
                [class.selected]="isContactSelected(contact.id)"
                (click)="toggleContact(contact.id)"
                role="option"
                [attr.aria-selected]="isContactSelected(contact.id)"
              >
                <div
                  class="dropdown-item-avatar"
                  [style.background-color]="getContactColor(contact)"
                  aria-hidden="true"
                >
                  {{ getInitials(contact) }}
                </div>
                <span class="dropdown-item-name">
                  {{ contact.firstName }} {{ contact.lastName }}
                  @if (isCurrentUser(contact.id)) {
                  <span class="you-label">(You)</span>
                  }
                </span>
                <img
                  [src]="
                    isContactSelected(contact.id)
                      ? 'imgs/checkbox-checked.png'
                      : 'imgs/checkbox-empty.png'
                  "
                  alt=""
                  class="dropdown-checkbox"
                  aria-hidden="true"
                />
              </div>
              }
            </div>
            }
          </div>
          @if (selectedContacts().length) {
          <div class="assigned-contacts">
            @for (contact of selectedContacts(); track contact.id) {
            <div
              class="contact-avatar"
              [style.background-color]="getContactColor(contact)"
              (click)="removeContact(contact.id)"
              role="button"
              tabindex="0"
              [attr.aria-label]="'Remove ' + contact.firstName + ' ' + contact.lastName"
            >
              {{ getInitials(contact) }}
            </div>
            }
          </div>
          }
        </div>

        <div class="category-form form-field">
          <div class="title-and-validation">
            <label for="category">Category<span class="required">*</span></label
            >@if (category?.touched && category?.invalid) {
            <p class="error-text" id="category-error" role="alert" aria-live="polite">
              Category is required.
            </p>
            }
          </div>

          <div class="select-wrapper">
            <select
              id="category"
              formControlName="category"
              [attr.aria-invalid]="category?.touched && category?.invalid"
              aria-describedby="category-error"
              aria-required="true"
            >
              <option value="">Select task category</option>
              <option value="Technical Task">Technical Task</option>
              <option value="User Story">User Story</option>
            </select>
            <span class="select-arrow" aria-hidden="true"></span>
          </div>
        </div>

        <div class="subtasks-form form-field">
          <label for="subtasks">Subtasks</label>
          <div class="subtask-input-wrapper">
            <input
              id="subtasks"
              type="text"
              placeholder="Add new subtask"
              [(ngModel)]="newSubtaskInput"
              (keyup.enter)="addSubtask()"
              [ngModelOptions]="{ standalone: true }"
              class="subtask-input"
            />
            <div class="subtask-actions">
              <img
                src="imgs/cancel-x-btn.png"
                alt="Cancel subtask"
                class="subtask-icon"
                (click)="clearSubtaskInput()"
              />
              <div class="subtask-divider"></div>
              <img
                src="imgs/checksubtasks.png"
                alt="Save subtask"
                class="subtask-icon"
                (click)="addSubtask()"
              />
            </div>
          </div>
          @if (subtasks().length) {
          <ul class="subtasks-list">
            @for (subtask of subtasks(); track subtask.id) {
            <li
              (mouseenter)="setHoveredSubtask(subtask.id)"
              (mouseleave)="setHoveredSubtask(null)"
              [class.hovered]="hoveredSubtaskId() === subtask.id"
              [class.editing]="editingSubtaskId() === subtask.id"
            >
              @if (editingSubtaskId() === subtask.id) {
              <input
                type="text"
                [value]="editingSubtaskTitle()"
                (input)="updateEditingSubtaskTitle($any($event.target).value)"
                (keydown.enter)="saveSubtaskEdit(subtask.id)"
                (blur)="saveSubtaskEdit(subtask.id)"
                class="subtask-edit-input"
                autofocus
              />
              <div class="subtask-actions">
                <img
                  src="imgs/dialog/deleve-normal.png"
                  alt="Delete subtask"
                  class="subtask-action-icon"
                  (click)="removeSubtask(subtask.id)"
                />
                <div class="subtask-divider"></div>
                <img
                  src="imgs/dialog/check-normal.png"
                  alt="Save subtask"
                  class="subtask-action-icon"
                  (click)="saveSubtaskEdit(subtask.id)"
                />
              </div>
              } @else {
              <span class="subtask-text">{{ subtask.title }}</span>
              @if (hoveredSubtaskId() === subtask.id) {
              <div class="subtask-actions">
                <img
                  src="imgs/dialog/edit-normal.png"
                  alt="Edit subtask"
                  class="subtask-action-icon"
                  (click)="startEditingSubtask(subtask)"
                />
                <div class="subtask-divider"></div>
                <img
                  src="imgs/dialog/deleve-normal.png"
                  alt="Delete subtask"
                  class="subtask-action-icon"
                  (click)="removeSubtask(subtask.id)"
                />
              </div>
              } }
            </li>
            }
          </ul>
          }
        </div>
      </div>
      <label class="required-mobile"><span>*</span>This field is required</label>
    </div>

    <div class="addtask-bottom">
      <div class="addtask-bottom-left">
        <label id="required-info"><span class="required">*</span>This field is required</label>
      </div>

      <div class="addtask-bottom-right">
        <button type="button" class="btn-secondary" id="cancel-btn" (click)="clearForm()">
          Clear
          <img src="imgs/cancel-x-btn.png" alt="" aria-hidden="true" />
        </button>
        <button type="button" class="btn-primary" id="submit-btn" (click)="createTask()">
          Create Task
          <img src="imgs/check-save-btn.png" alt="" aria-hidden="true" />
        </button>
      </div>
    </div>
  </div>
</section>
<app-toast></app-toast>
